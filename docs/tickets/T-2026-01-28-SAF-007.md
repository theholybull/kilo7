Title: Phase 4 Enforcement Wiring — Gate on Perception Hazards (Yellow)
Date: 2026-01-28
Status: Proposed

Summary
Wire Safety Gate enforcement to `state_perception_v1` truth without violating single-authority model. Deny when hazard metrics indicate insufficient stop distance or explicit hazard level. Rollout behind config flag; default disabled.

Justification (Yellow Zone)
- Changes safety triggers; requires explicit ticket and justification.
- Enforcement depends on Phase 3 perception truth; now available (stub publishing with fields: `hazard_level`, `min_stop_distance_m`, `stale`).

Scope
- Additive-only config keys under `safety.perception_enforcement.*`:
  - `enabled: false` (default)
  - `min_hazard_level: "WARN"` (enum: NONE/UNKNOWN/WARN/STOP)
  - `min_stop_buffer_m: 0.0` (deny if required buffer exceeds available)
  - `stale_denies: true` (deny if perception truth is stale)
- Safety Gate subscribes to `/kilo/state/perception_json` and computes:
  - deny if `hazard_level >= min_hazard_level`
  - deny if `min_stop_distance_m` is not None and `stop_buffer_m < min_stop_distance_m`
  - deny if `stale_denies` and `stale==true`
- Publish additive observability:
  - `perception_ok` (bool), `perception_age_ms` (int|null)
  - `perception_reason` (string)

Contracts (additive)
- No schema changes to `state_safety_v1`; additive fields only.
- No changes to `state_perception_v1` beyond existing additive fields.

Acceptance Checks (to be implemented when enabled)
1) With `enabled=true`, publishing `hazard_level=STOP` → Safety Gate denies with reason `PERCEPTION_HAZARD` and control clamps 0.0.
2) With `enabled=true`, publishing `min_stop_distance_m` greater than safety model `stop_buffer_m` → deny with reason `INSUFFICIENT_STOP_BUFFER`.
3) With `stale_denies=true`, `stale=true` in perception truth → deny with reason `COMPONENT_MISSING` or `PERCEPTION_STALE` (additive reason code).
4) With `enabled=false`, the above inputs do not affect Safety Gate decisions.

Risks & Mitigations
- False positives from noisy perception → hysteresis and minimum dwell time on hazard before deny (configurable future additive).
- Clock skew → use robot receipt time to compute `perception_age_ms`.

Rollout Plan
- Implement behind `enabled=false`.
- Add integration tests gated by config; default test matrix keeps `enabled=false` to preserve current PASS baseline.
- Document in `DECISIONS_LEDGER.md` upon enablement.

Artifacts
- Tests: `robot/test_phase4_enforcement_wiring.py` (added once wiring is implemented).
- Logs: `logs/phase_4/` captures for hazard denial scenarios.
